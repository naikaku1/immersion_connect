<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Immersion AR Remote</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        :root {
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            --bg-base: #000;
        }
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg-base); color: #fff;
            font-family: var(--font); overflow: hidden;
            user-select: none; -webkit-user-select: none;
        }

        /* --- „É™„É¢„Ç≥„É≥ÁîªÈù¢ (ÈÄöÂ∏∏„É¢„Éº„Éâ) --- */
        #remote-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
            background: rgba(0,0,0,0.8); z-index: 10;
            transition: transform 0.3s ease;
        }
        #remote-ui.hidden { transform: translateY(100%); }

        /* „Ç¢„Éº„Éà„ÉØ„Éº„ÇØ & ÊÉÖÂ†± */
        #artwork-card {
            width: 60vw; height: 60vw; margin: 20px auto;
            border-radius: 12px; background: #222; background-size: cover; background-position: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .meta-info { text-align: center; margin-bottom: 20px; }
        #song-title { font-size: 20px; font-weight: 700; margin-bottom: 5px; }
        #artist-name { font-size: 14px; color: rgba(255,255,255,0.6); }

        /* „Ç≥„É≥„Éà„É≠„Éº„É´ */
        .controls { display: flex; justify-content: space-between; align-items: center; max-width: 300px; margin: 0 auto; width: 100%; }
        button.ctrl-btn {
            background: none; border: none; color: white; cursor: pointer; padding: 10px;
        }
        button.ctrl-btn svg { width: 32px; height: 32px; fill: white; }
        #play-pause svg { width: 50px; height: 50px; }

        /* ARÂàá„ÇäÊõø„Åà„Éú„Çø„É≥ */
        #enter-ar-btn {
            margin-top: auto; margin-bottom: 20px;
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            border: none; padding: 15px; border-radius: 30px;
            color: white; font-weight: bold; font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,114,255,0.4);
        }

        /* --- AR„Ç™„Éº„Éê„Éº„É¨„Ç§ (AR„É¢„Éº„ÉâÊôÇ) --- */
        #ar-overlay-ui {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px;
            z-index: 1000; pointer-events: none; display: none;
            text-align: center;
        }
        #ar-overlay-ui.visible { display: block; }
        #exit-ar-btn {
            pointer-events: auto; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); color: white;
            padding: 10px 24px; border-radius: 20px; font-weight: 600;
        }
    </style>
</head>
<body>

    <a-scene 
        mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/examples/image-tracking/assets/card-example/card.mind;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            
            <a-plane color="#000" opacity="0.7" position="0 0 0" width="1" height="0.6"></a-plane>
            
            <a-text id="ar-title" value="Waiting..." color="#fff" align="center" width="1.8" position="0 0.2 0.01"></a-text>
            
            <a-text id="ar-lyric" value="Scan the Card" color="#fff" align="center" width="2" position="0 0 0.05" 
                    animation="property: scale; from: 0.9 0.9 0.9; to: 1.05 1.05 1.05; dir: alternate; dur: 1000; loop: true"></a-text>

            <a-text id="ar-next" value="" color="#aaa" align="center" width="1.2" position="0 -0.15 0.01"></a-text>

        </a-entity>
    </a-scene>

    <div id="remote-ui">
        <div style="flex:1;"></div>
        <div id="artwork-card"></div>
        <div class="meta-info">
            <div id="song-title">Not Connected</div>
            <div id="artist-name">-</div>
        </div>
        <div class="controls">
            <button class="ctrl-btn" onclick="sendCommand('prev')">‚èÆ</button>
            <button class="ctrl-btn" id="play-pause" onclick="sendCommand('playpause')">‚ñ∂</button>
            <button class="ctrl-btn" onclick="sendCommand('next')">‚è≠</button>
        </div>
        <div style="flex:1;"></div>
        <button id="enter-ar-btn">üì∑ AR„É¢„Éº„ÉâËµ∑Âãï</button>
    </div>

    <div id="ar-overlay-ui">
        <button id="exit-ar-btn">ARÁµÇ‰∫Ü / „É™„É¢„Ç≥„É≥„Å´Êàª„Çã</button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const targetId = params.get('id');
        let conn = null;
        let isPlaying = false;
        
        // PeerJS Setup
        const peer = new Peer({ config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } });

        peer.on('open', (id) => {
            if (targetId) connectToPC(targetId);
        });

        function connectToPC(id) {
            conn = peer.connect(id);
            conn.on('open', () => { document.getElementById('song-title').innerText = "Connected"; });
            conn.on('data', handleData);
        }

        function handleData(data) {
            if (data.type === 'info') {
                // ÈÄöÂ∏∏UIÊõ¥Êñ∞
                document.getElementById('song-title').innerText = data.title;
                document.getElementById('artist-name').innerText = data.artist;
                if(data.thumbnail) document.getElementById('artwork-card').style.backgroundImage = `url('${data.thumbnail}')`;
                
                // AR„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
                const arTitle = document.querySelector('#ar-title');
                if(arTitle) arTitle.setAttribute('value', data.title);
                
                // „Ç¢„Ç§„Ç≥„É≥Êõ¥Êñ∞
                isPlaying = data.isPlaying;
                document.getElementById('play-pause').innerHTML = isPlaying ? '‚è∏' : '‚ñ∂';
            }
            if (data.type === 'lyric_index' && data.allLyrics) {
                // Ê≠åË©ûÊõ¥Êñ∞
                const current = data.allLyrics[data.index]?.text || "";
                const next = data.allLyrics[data.index + 1]?.text || "";
                
                const arLyric = document.querySelector('#ar-lyric');
                const arNext = document.querySelector('#ar-next');
                
                if(arLyric) arLyric.setAttribute('value', current);
                if(arNext) arNext.setAttribute('value', next);
            }
            // Ê≠åË©ûÈÖçÂàó„ÅåÊù•„Å™„ÅÑÂ†¥Âêà„ÅÆÁ∞°ÊòìÂØæÂøú
            if (data.type === 'lyric_text') {
                 document.querySelector('#ar-lyric').setAttribute('value', data.text);
            }
        }

        function sendCommand(cmd) {
            if (conn && conn.open) conn.send({ command: cmd });
        }

        // --- AR Mode Control ---
        const arScene = document.querySelector('a-scene');
        const remoteUI = document.getElementById('remote-ui');
        const arOverlay = document.getElementById('ar-overlay-ui');
        const enterBtn = document.getElementById('enter-ar-btn');
        const exitBtn = document.getElementById('exit-ar-btn');

        // ÂàùÊúüÁä∂ÊÖã„ÅØARÂÅúÊ≠¢
        arScene.pause();
        arScene.style.display = 'none';

        enterBtn.onclick = () => {
            remoteUI.classList.add('hidden');
            arOverlay.classList.add('visible');
            arScene.style.display = 'block';
            arScene.play();
            // MindAR„ÅÆ„Ç∑„Çπ„ÉÜ„É†Ëµ∑Âãï
            arScene.systems["mindar-image-system"].start();
        };

        exitBtn.onclick = () => {
            remoteUI.classList.remove('hidden');
            arOverlay.classList.remove('visible');
            // MindARÂÅúÊ≠¢
            arScene.systems["mindar-image-system"].stop();
            arScene.style.display = 'none';
        };
    </script>
</body>
</html>
