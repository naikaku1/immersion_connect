<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Immersion Spatial AR</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        :root {
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            --text-main: #ffffff;
            --bg-base: #000;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg-base); color: var(--text-main);
            font-family: var(--font);
            overflow: hidden; position: fixed; inset: 0;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        #backdrop {
            position: absolute; inset: -20px; z-index: -2;
            background-color: #111;
            background-size: cover; background-position: center;
            filter: blur(80px) brightness(0.4);
            transition: opacity 0.5s;
        }
        #ar-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -3;
            opacity: 0; transition: opacity 0.5s;
        }
        #css-world {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
            opacity: 0; transition: opacity 0.5s;
        }

        /* UI Layer */
        #ui-2d-container {
            position: absolute; inset: 0; z-index: 10;
            display: flex; flex-direction: column;
            padding: max(20px, env(safe-area-inset-top)) 24px max(30px, env(safe-area-inset-bottom)) 24px;
            transition: opacity 0.5s, transform 0.5s;
            background: rgba(0,0,0,0.4);
        }

        /* AR Active State */
        body.ar-active #backdrop { opacity: 0; }
        body.ar-active #ar-video { opacity: 1; }
        body.ar-active #css-world { opacity: 1; }
        body.ar-active #ui-2d-container {
            background: transparent; justify-content: flex-end;
        }
        body.ar-active #artwork-wrapper, 
        body.ar-active .meta-info, 
        body.ar-active .lyrics-side { display: none !important; }
        body.ar-active .controls-area {
            margin-bottom: 40px; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(20px); padding: 20px;
            border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);
        }

        /* 3D Objects */
        .ar-card {
            width: 300px; height: 300px;
            background-size: cover; background-position: center;
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.2);
            backface-visibility: hidden; 
        }
        .ar-lyric-box {
            width: 800px; text-align: center; font-weight: 800;
            color: rgba(255,255,255,0.2);
            transition: all 0.3s;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .ar-lyric-box.active {
            color: #fff; text-shadow: 0 0 30px rgba(255,255,255,0.6);
        }

        /* 2D Elements */
        #artwork-wrapper { flex: 0 0 auto; display: flex; justify-content: center; margin-bottom: 20px; }
        #artwork-card {
            width: 70vw; height: 70vw; max-width: 300px; max-height: 300px;
            border-radius: 12px; background: rgba(255,255,255,0.1);
            background-size: cover; background-position: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .meta-info { text-align: center; margin-bottom: 10px; color: #fff; }
        #song-title { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        #artist-name { font-size: 16px; color: rgba(255,255,255,0.6); }

        .lyrics-side { flex: 1; overflow-y: auto; text-align: center; mask-image: linear-gradient(transparent, black 10%, black 90%, transparent); }
        .lyric-item { padding: 10px; color: rgba(255,255,255,0.3); font-weight: 700; font-size: 20px; transition: all 0.3s; }
        .lyric-item.active { color: #fff; transform: scale(1.1); text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        
        /* Controls */
        .controls-area { width: 100%; }
        .progress-wrap input { width: 100%; }
        .buttons-row { display: flex; justify-content: space-between; align-items: center; max-width: 300px; margin: 10px auto; }
        button { background: none; border: none; color: #fff; cursor: pointer; }
        .play-icon { width: 48px; height: 48px; fill: #fff; }
        .skip-icon { width: 32px; height: 32px; fill: #fff; }

        #ar-toggle-btn {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(40,40,40,0.6); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px; border-radius: 20px;
            font-size: 12px; font-weight: bold; color: #fff;
        }
        #ar-toggle-btn.active { background: #fff; color: #000; }
        
        #status-pill {
            position: absolute; top: 20px; left: 20px;
            font-size: 10px; font-weight: bold; background: rgba(0,0,0,0.5);
            padding: 4px 10px; border-radius: 10px; color: #aaa; z-index: 1000;
        }

        /* デバッグログ表示用 (小さく左下に) */
        #debug-log {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace;
            font-size: 10px; overflow-y: scroll; pointer-events: none;
            z-index: 9999; padding: 5px; display: none; /* 必要なら block に */
        }
    </style>
</head>
<body>
    <video id="ar-video" autoplay playsinline muted></video>
    <div id="backdrop"></div>
    <div id="css-world"></div>

    <div id="status-pill">Init...</div>
    <button id="ar-toggle-btn">AR MODE</button>
    <div id="debug-log"></div>

    <div class="container" id="ui-2d-container">
        <div id="artwork-wrapper"><div id="artwork-card"></div></div>
        <div class="meta-info">
            <div id="song-title">Not Playing</div>
            <div id="artist-name">-</div>
        </div>
        <div class="lyrics-side">
            <ul id="lyrics-list">
                <li style="height:40vh"></li>
                <li class="lyric-item">Immersion Remote</li>
                <li style="height:40vh"></li>
            </ul>
        </div>
        <div class="controls-area">
            <div class="progress-area">
                <input type="range" id="seek-bar" min="0" max="100" value="0" style="width:100%">
            </div>
            <div class="buttons-row">
                <button onclick="sendCommand('seek', -10)"><svg class="skip-icon" viewBox="0 0 24 24"><path d="M19 6L9 12l10 6V6zM7 6v12h2V6H7z"/></svg></button>
                <button id="play-pause-btn" onclick="sendCommand('playpause')">
                    <svg id="icon-play" class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="icon-pause" class="play-icon" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button onclick="sendCommand('next')"><svg class="skip-icon" viewBox="0 0 24 24"><path d="M5 18l10-6-10-6v12zm12-12v12h2V6h-2z"/></svg></button>
            </div>
        </div>
    </div>

    <script>
        // デバッグログ関数
        function log(msg) {
            console.log(msg);
            const d = document.getElementById('debug-log');
            d.style.display = 'block'; // エラーが出たら表示
            d.innerHTML = `<div>${msg}</div>` + d.innerHTML;
        }

        // グローバル変数
        window.currentLyricsData = [];
        window.currentImgUrl = "";
        window.currentTitle = "";
        window.isAR = false;
        
        // PeerJS接続処理
        const statusPill = document.getElementById('status-pill');
        const params = new URLSearchParams(window.location.search);
        const targetId = params.get('id');

        // UI更新関数 (Global)
        window.updateUIFromData = (data) => {
            // ここは後で定義するが、初期状態で空関数にしておく
        };

        if (!targetId) {
            statusPill.innerText = "ERROR: NO ID";
            log("URLに ?id=... がありません");
        } else {
            statusPill.innerText = "Connecting...";
            const peer = new Peer({
                config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
            });

            peer.on('open', (id) => {
                log("My Peer ID: " + id);
                const conn = peer.connect(targetId);
                window.conn = conn; // グローバルに保存

                conn.on('open', () => {
                    statusPill.innerText = "CONNECTED";
                    log("Connected to PC!");
                    setTimeout(() => statusPill.style.opacity = 0, 3000);
                });

                conn.on('data', (data) => {
                    // グローバルなUI更新関数を呼ぶ
                    if(window.updateUIFromData) window.updateUIFromData(data);
                });

                conn.on('close', () => {
                    statusPill.innerText = "DISCONNECTED";
                    statusPill.style.opacity = 1;
                    log("Connection Closed");
                });
                
                conn.on('error', (err) => log("Conn Error: " + err));
            });

            peer.on('error', (err) => {
                statusPill.innerText = "PEER ERROR";
                log("Peer Error: " + err);
            });
        }

        // 送信関数 (Global)
        window.sendCommand = (cmd, val) => {
            if (navigator.vibrate) navigator.vibrate(10);
            if (window.conn && window.conn.open) {
                window.conn.send({ command: cmd, value: val });
            } else {
                log("Not connected, cant send");
            }
        };
    </script>

    <script type="module">
        // ライブラリの読み込みに失敗しても通信だけは死なないようにtry-catchはできないが、
        // 上のスクリプトが別なので通信は生きているはず。
        import * as THREE from 'three';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';
        import { DeviceOrientationControls } from 'three/addons/controls/DeviceOrientationControls.js';

        const arBtn = document.getElementById('ar-toggle-btn');
        const arVideo = document.getElementById('ar-video');
        const artworkCard2D = document.getElementById('artwork-card');
        const backdrop = document.getElementById('backdrop');
        const lyricsList2D = document.getElementById('lyrics-list');
        
        // Three.js Variables
        let camera, scene, renderer, controls;
        let arArtworkObj = null;
        let arLyricsGroup = new THREE.Group();
        let lyricObjects = [];

        // --- UI更新ロジック (通信から呼ばれる) ---
        window.updateUIFromData = (data) => {
            if (data.type === 'time') {
                document.getElementById('seek-bar').value = data.current;
                document.getElementById('seek-bar').max = data.duration;
                return;
            }

            if (data.type === 'info') {
                // 2D更新
                document.getElementById('song-title').innerText = data.title;
                document.getElementById('artist-name').innerText = data.artist;
                
                const playIcon = document.getElementById('icon-play');
                const pauseIcon = document.getElementById('icon-pause');
                if (data.isPlaying) {
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                } else {
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                }

                if (data.thumbnail && data.thumbnail !== window.currentImgUrl) {
                    window.currentImgUrl = data.thumbnail;
                    artworkCard2D.style.backgroundImage = `url('${data.thumbnail}')`;
                    backdrop.style.backgroundImage = `url('${data.thumbnail}')`;
                    update3DArtwork(data.thumbnail);
                }

                if (data.allLyrics) {
                    window.currentLyricsData = data.allLyrics;
                    render2DLyrics(data.allLyrics);
                    update3DLyrics(data.allLyrics);
                }
            }

            if (data.type === 'lyric_index') {
                highlight2DLyric(data.index);
                highlight3DLyric(data.index);
            }
        };

        // --- 2D Helpers ---
        function render2DLyrics(lyrics) {
            lyricsList2D.innerHTML = '<li style="height:40vh"></li>';
            lyrics.forEach((line, i) => {
                const li = document.createElement('li');
                li.className = 'lyric-item';
                li.id = `line2d-${i}`;
                li.innerText = line.text;
                li.onclick = () => window.sendCommand('scrub', line.time);
                lyricsList2D.appendChild(li);
            });
            lyricsList2D.innerHTML += '<li style="height:40vh"></li>';
        }

        function highlight2DLyric(index) {
            const active = document.querySelector('.lyric-item.active');
            if(active) active.classList.remove('active');
            const next = document.getElementById(`line2d-${index}`);
            if(next) {
                next.classList.add('active');
                if(!window.isAR) {
                    next.scrollIntoView({behavior: "smooth", block: "center"});
                }
            }
        }

        // --- 3D / AR Logic ---
        function init3D() {
            if (renderer) return;
            const container = document.getElementById('css-world');
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 5000);
            camera.position.set(0, 0, 0);
            scene = new THREE.Scene();
            renderer = new CSS3DRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            controls = new DeviceOrientationControls(camera);

            // Artwork
            const artDiv = document.createElement('div');
            artDiv.className = 'ar-card';
            if(window.currentImgUrl) artDiv.style.backgroundImage = `url('${window.currentImgUrl}')`;
            arArtworkObj = new CSS3DObject(artDiv);
            arArtworkObj.position.set(0, 0, -600);
            scene.add(arArtworkObj);

            // Lyrics
            arLyricsGroup.position.set(0, -400, -600);
            scene.add(arLyricsGroup);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (window.isAR && controls) {
                controls.update();
                renderer.render(scene, camera);
            }
        }

        window.addEventListener('resize', () => {
            if(!camera) return;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Toggle AR
        arBtn.addEventListener('click', async () => {
            if (window.isAR) {
                const tracks = arVideo.srcObject?.getTracks();
                if(tracks) tracks.forEach(t => t.stop());
                arVideo.srcObject = null;
                document.body.classList.remove('ar-active');
                arBtn.classList.remove('active');
                arBtn.innerText = "AR MODE";
                window.isAR = false;
            } else {
                try {
                    // iOS Permission
                    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission !== 'granted') return alert("ジャイロが必要です");
                    }
                    // Camera
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment", width: { ideal: 1280 } }, audio: false
                    });
                    arVideo.srcObject = stream;
                    arVideo.onloadedmetadata = () => arVideo.play();

                    init3D();
                    update3DArtwork(window.currentImgUrl);
                    update3DLyrics(window.currentLyricsData);

                    document.body.classList.add('ar-active');
                    arBtn.classList.add('active');
                    arBtn.innerText = "CLOSE AR";
                    window.isAR = true;
                } catch(e) {
                    alert("AR Error: " + e.message);
                }
            }
        });

        // 3D Helpers
        function update3DArtwork(url) {
            if(arArtworkObj && url) arArtworkObj.element.style.backgroundImage = `url('${url}')`;
        }
        function update3DLyrics(lyrics) {
            for(let i=arLyricsGroup.children.length-1; i>=0; i--) arLyricsGroup.remove(arLyricsGroup.children[i]);
            lyricObjects = [];
            if(!lyrics) return;
            lyrics.forEach((line, i) => {
                const el = document.createElement('div');
                el.className = 'ar-lyric-box';
                el.innerText = line.text;
                const obj = new CSS3DObject(el);
                obj.position.set(0, i * 100, 0);
                arLyricsGroup.add(obj);
                lyricObjects.push(obj);
            });
        }
        function highlight3DLyric(index) {
            if(!lyricObjects[index]) return;
            lyricObjects.forEach((obj, i) => {
                const el = obj.element;
                const dist = i - index;
                el.classList.remove('active');
                if (dist === 0) {
                    el.classList.add('active');
                    obj.position.set(0, -250, 50);
                    obj.rotation.x = 0;
                    el.style.opacity = 1;
                    el.style.fontSize = "40px";
                } else {
                    obj.position.set(0, -250 - (dist * 120), -200 - (Math.abs(dist) * 100));
                    obj.rotation.x = dist * 0.1;
                    if(Math.abs(dist) > 5) el.style.opacity = 0;
                    else el.style.opacity = 0.4 - (Math.abs(dist) * 0.05);
                    el.style.fontSize = "24px";
                }
            });
        }
    </script>
</body>
</html>
